<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Agent Web Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .section {
            padding: 30px;
            border-right: 1px solid #eee;
        }

        .section:last-child {
            border-right: none;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .feedback-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
        }

        .feedback-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .feedback-item:last-child {
            margin-bottom: 0;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feedback-rating {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .feedback-domain {
            color: #666;
            font-size: 12px;
        }

        .feedback-comment {
            color: #333;
            line-height: 1.5;
        }

        .feedback-meta {
            margin-top: 10px;
            font-size: 11px;
            color: #888;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .section:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Movie Agent Web Client</h1>
            <p>Interact with the Movie Agent and manage feedback</p>
        </div>

        <div class="main-content">
            <!-- Feedback Management Section -->
            <div class="section">
                <h2>üìù Feedback Management</h2>
                
                <div id="status" class="status" style="display: none;"></div>

                <!-- Add Feedback Form -->
                <form id="feedbackForm">
                    <div class="form-group">
                        <label for="rating">Rating (1-5 stars):</label>
                        <select id="rating" required>
                            <option value="">Select rating...</option>
                            <option value="1">‚≠ê (1 star)</option>
                            <option value="2">‚≠ê‚≠ê (2 stars)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="comment">Comment:</label>
                        <textarea id="comment" placeholder="Share your feedback about the movie recommendations..." required></textarea>
                    </div>


                    <button type="submit" class="btn btn-success">Add Feedback</button>
                </form>

                <!-- Feedback Actions -->
                <div style="margin-top: 20px;">
                    <button onclick="loadFeedback()" class="btn">Refresh Feedback</button>
                    <button onclick="loadStats()" class="btn btn-secondary">View Statistics</button>
                    <button onclick="testEndpoint()" class="btn">Test Endpoint</button>
                </div>

                <!-- Statistics -->
                <div id="stats" style="display: none;">
                    <h3>üìä Statistics</h3>
                    <div id="statsContent"></div>
                </div>

                <!-- Feedback List -->
                <div id="feedbackList" style="margin-top: 20px;">
                    <h3>üìã Recent Feedback</h3>
                    <div id="feedbackContent" class="feedback-list">
                        <div class="loading">Loading feedback...</div>
                    </div>
                </div>
            </div>

            <!-- Movie Agent Interaction Section -->
            <div class="section">
                <h2>ü§ñ Movie Agent</h2>
                
                <!-- Agent Status -->
                <div id="agentStatus" class="status info">
                    <div class="loading">Checking agent connection...</div>
                </div>

                <!-- Quick Actions -->
                <div style="margin-bottom: 20px;">
                    <button onclick="checkAgentStatus()" class="btn">Check Agent Status</button>
                    <button onclick="testFeedbackAuth()" class="btn btn-secondary">Test Feedback Auth</button>
                </div>

                <!-- Feedback Auth Test -->
                <div id="feedbackAuthTest" style="display: none;">
                    <h3>üîê Feedback Auth Test</h3>
                    <div class="form-group">
                        <label for="clientId">Client Agent ID:</label>
                        <input type="number" id="clientId" value="">
                    </div>
                    <div class="form-group">
                        <label for="serverId">Server Agent ID:</label>
                        <input type="number" id="serverId" value="">
                    </div>
                    <button onclick="getFeedbackAuthId()" class="btn">Get Feedback Auth ID</button>
                    <div id="authResult" style="margin-top: 10px;"></div>
                </div>

                <!-- API Information -->
                <div style="margin-top: 30px;">
                    <h3>üîó API Endpoints</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px;">
                        <div><strong>Feedback JSON:</strong> <a href="/.well-known/feedback.json" target="_blank">/.well-known/feedback.json</a></div>
                        <div><strong>Feedback API:</strong> /api/feedback</div>
                        <div><strong>Stats API:</strong> /api/feedback/stats</div>
                        <div><strong>Agent Status:</strong> /api/movie-agent/status</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentFeedback = [];
        let currentStats = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadFeedback();
            checkAgentStatus();
            loadDefaultAgentIds();
            
            // Setup form submission
            document.getElementById('feedbackForm').addEventListener('submit', handleFeedbackSubmit);
        });

        // Load default agent IDs from environment variables
        async function loadDefaultAgentIds() {
            try {
                const response = await fetch('/api/config/agent-ids');
                if (response.ok) {
                    const config = await response.json();
                    document.getElementById('clientId').value = config.clientId;
                    document.getElementById('serverId').value = config.serverId;
                }
            } catch (error) {
                console.warn('Failed to load default agent IDs:', error);
                // Fallback to hardcoded defaults
                document.getElementById('clientId').value = '1';
                document.getElementById('serverId').value = '4';
            }
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Handle feedback form submission
        async function handleFeedbackSubmit(e) {
            e.preventDefault();
            
            const rating = document.getElementById('rating').value;
            const comment = document.getElementById('comment').value;
            
            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rating: parseInt(rating),
                        comment
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus(`Feedback added successfully! ID: ${result.feedbackId}`, 'success');
                    document.getElementById('feedbackForm').reset();
                    loadFeedback();
                    loadStats();
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Load feedback list
        async function loadFeedback() {
            try {
                const response = await fetch('/api/feedback');
                const feedback = await response.json();
                
                currentFeedback = feedback;
                displayFeedback(feedback);
            } catch (error) {
                document.getElementById('feedbackContent').innerHTML = 
                    `<div class="status error">Error loading feedback: ${error.message}</div>`;
            }
        }

        // Display feedback list
        function displayFeedback(feedback) {
            const content = document.getElementById('feedbackContent');
            
            if (feedback.length === 0) {
                content.innerHTML = '<div class="loading">No feedback records found</div>';
                return;
            }
            
            content.innerHTML = feedback.map(item => `
                <div class="feedback-item">
                    <div class="feedback-header">
                        <span class="feedback-rating">${item.rating / 20}/5 stars (${item.rating}%)</span>
                        <span class="feedback-domain">${item.domain}</span>
                    </div>
                    <div class="feedback-comment">${item.notes}</div>
                    <div class="feedback-meta">
                        ID: ${item.id} | Created: ${new Date(item.createdAt).toLocaleString()}
                        ${item.feedbackAuthId ? ` | Auth ID: ${item.feedbackAuthId.substring(0, 20)}...` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/feedback/stats');
                const stats = await response.json();
                
                currentStats = stats;
                displayStats(stats);
            } catch (error) {
                showStatus(`Error loading stats: ${error.message}`, 'error');
            }
        }

        // Display statistics
        function displayStats(stats) {
            const statsDiv = document.getElementById('stats');
            const content = document.getElementById('statsContent');
            
            const avgStars = (stats.averageRating / 20).toFixed(1);
            
            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${avgStars}</div>
                        <div class="stat-label">Avg Rating</div>
                    </div>
                </div>
                
                ${Object.keys(stats.byDomain).length > 0 ? `
                    <h4>By Domain:</h4>
                    <ul>
                        ${Object.entries(stats.byDomain).map(([domain, count]) => 
                            `<li>${domain}: ${count} records</li>`
                        ).join('')}
                    </ul>
                ` : ''}
                
                ${Object.keys(stats.byRating).length > 0 ? `
                    <h4>By Rating:</h4>
                    <ul>
                        ${Object.entries(stats.byRating).map(([rating, count]) => {
                            const stars = parseInt(rating) / 20;
                            return `<li>${stars}/5 stars (${rating}%): ${count} records</li>`;
                        }).join('')}
                    </ul>
                ` : ''}
            `;
            
            statsDiv.style.display = 'block';
        }

        // Test feedback endpoint
        async function testEndpoint() {
            try {
                const response = await fetch('/.well-known/feedback.json');
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(`‚úÖ Endpoint working! Found ${data.length} feedback records`, 'success');
                } else {
                    showStatus(`‚ùå Endpoint error: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error testing endpoint: ${error.message}`, 'error');
            }
        }

        // Check movie agent status
        async function checkAgentStatus() {
            const statusEl = document.getElementById('agentStatus');
            statusEl.innerHTML = '<div class="loading">Checking agent connection...</div>';
            
            try {
                const response = await fetch('/api/movie-agent/status');
                const result = await response.json();
                
                if (result.status === 'connected') {
                    statusEl.innerHTML = `
                        <div class="status success">
                            ‚úÖ Connected to Movie Agent<br>
                            <small>URL: ${result.url}</small>
                        </div>
                    `;
                    document.getElementById('feedbackAuthTest').style.display = 'block';
                } else {
                    statusEl.innerHTML = `
                        <div class="status error">
                            ‚ùå Movie Agent Disconnected<br>
                            <small>Error: ${result.error}</small><br>
                            <small>URL: ${result.url}</small>
                        </div>
                    `;
                }
            } catch (error) {
                statusEl.innerHTML = `
                    <div class="status error">
                        ‚ùå Error checking agent status<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // Test feedback auth
        function testFeedbackAuth() {
            document.getElementById('feedbackAuthTest').style.display = 'block';
        }

        // Get feedback auth ID
        async function getFeedbackAuthId() {
            const clientId = document.getElementById('clientId').value;
            const serverId = document.getElementById('serverId').value;
            const resultEl = document.getElementById('authResult');
            
            if (!clientId || !serverId) {
                resultEl.innerHTML = '<div class="status error">Please enter both Client ID and Server ID</div>';
                return;
            }
            
            try {
                const response = await fetch(`/api/feedback-auth/${clientId}/${serverId}`);
                const result = await response.json();
                
                if (response.ok) {
                    resultEl.innerHTML = `
                        <div class="status success">
                            <strong>Feedback Auth ID:</strong><br>
                            <code style="word-break: break-all;">${result.feedbackAuthId || 'null'}</code>
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `<div class="status error">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
